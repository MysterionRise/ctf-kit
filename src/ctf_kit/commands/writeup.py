"""
Generate writeup documentation for solved challenges.
"""

from datetime import UTC, datetime
from pathlib import Path
from typing import Annotated

from rich.console import Console
from rich.panel import Panel
import typer

console = Console()

WRITEUP_TEMPLATE = """# {challenge_name}

## Challenge Info
- **Category**: {category}
- **Points**: {points}
- **Solved**: {solved_time}

## Description
> {description}

## TL;DR
{tldr}

## Solution

### Step 1: Initial Analysis
{analysis}

### Step 2: Solution
{solution}

## Flag
```text
{flag}
```

## Lessons Learned
{lessons}

## Tools Used
{tools}

---
*Generated by CTF Kit*
"""

# Maximum length for inline content
MAX_CONTENT_LENGTH = 500


def generate_writeup(
    path: Annotated[
        Path | None, typer.Argument(help="Challenge path (default: current directory)")
    ] = None,
    output_format: Annotated[
        str, typer.Option("--format", "-f", help="Output format: markdown, html")
    ] = "markdown",
    output: Annotated[Path | None, typer.Option("--output", "-o", help="Output file path")] = None,
) -> None:
    """
    Generate a writeup for a solved challenge.

    Uses information from .ctf/ folder (analysis.md, approach.md, etc.)
    to create a comprehensive writeup.

    Examples:
        ctf writeup                    # Generate for current challenge
        ctf writeup --format html      # Generate HTML writeup
        ctf writeup -o writeup.md      # Specify output file
    """
    _ = output_format  # Reserved for future HTML support

    target_path = path or Path.cwd()
    ctf_dir = target_path / ".ctf"

    if not ctf_dir.exists():
        console.print("[red]No .ctf/ folder found. Run 'ctf init' first.[/]")
        raise typer.Exit(1)

    # Gather information
    challenge_name = target_path.name

    # Read analysis.md if exists
    analysis_file = ctf_dir / "analysis.md"
    analysis_content = analysis_file.read_text() if analysis_file.exists() else ""

    # Read approach.md if exists
    approach_file = ctf_dir / "approach.md"
    approach_content = approach_file.read_text() if approach_file.exists() else ""

    # Check for flag.txt
    flag_file = target_path / "flag.txt"
    flag = flag_file.read_text().strip() if flag_file.exists() else "FLAG_NOT_FOUND"

    # Check for solve script
    solve_files = list(target_path.glob("solve.*")) + list(target_path.glob("exploit.*"))
    solution_code = ""
    if solve_files:
        try:
            solution_code = f"```python\n{solve_files[0].read_text()}\n```"
        except OSError:
            solution_code = f"See: {solve_files[0].name}"

    # Detect category from analysis
    category = _detect_category(analysis_content)

    # Generate writeup
    writeup_content = WRITEUP_TEMPLATE.format(
        challenge_name=challenge_name,
        category=category,
        points="?",
        solved_time=datetime.now(tz=UTC).strftime("%Y-%m-%d %H:%M UTC"),
        description="<!-- Add challenge description -->",
        tldr="<!-- One-line summary of the solution -->",
        analysis=analysis_content[:MAX_CONTENT_LENGTH]
        if analysis_content
        else "<!-- Add analysis -->",
        solution=solution_code
        or approach_content[:MAX_CONTENT_LENGTH]
        or "<!-- Add solution steps -->",
        flag=flag,
        lessons="<!-- What did you learn? -->",
        tools="<!-- List tools used -->",
    )

    # Determine output path
    output_path = output if output else ctf_dir / "writeup.md"

    # Write output
    output_path.write_text(writeup_content)

    # Truncate flag display for privacy
    flag_preview = flag[:20] + "..." if len(flag) > 20 else flag

    console.print(
        Panel(
            f"[green]Writeup generated![/]\n\n"
            f"Output: [cyan]{output_path}[/]\n"
            f"Flag: [green]{flag_preview}[/]\n\n"
            f"Edit the writeup to add:\n"
            f"  Challenge description\n"
            f"  Detailed solution steps\n"
            f"  Lessons learned",
            title="Writeup Generated",
        )
    )


def _detect_category(content: str) -> str:
    """Detect challenge category from content."""
    content_lower = content.lower()

    category_keywords = {
        "Crypto": ["crypto"],
        "Forensics": ["forensics"],
        "Pwn": ["pwn", "binary"],
        "Web": ["web"],
        "Reversing": ["reverse"],
        "Steganography": ["stego"],
        "OSINT": ["osint"],
    }

    for category, keywords in category_keywords.items():
        if any(kw in content_lower for kw in keywords):
            return category

    return "Unknown"
